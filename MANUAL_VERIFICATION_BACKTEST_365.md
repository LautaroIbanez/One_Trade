# Gu√≠a de Verificaci√≥n Manual - Backtests de 365 D√≠as

## Objetivo
Verificar que el sistema genera y mantiene backtests de al menos 365 d√≠as para todos los s√≠mbolos y modos.

---

## Pre-requisitos

‚úÖ Cambios implementados en:
- `webapp/app.py`
- `btc_1tpd_backtester/utils.py`  
- `verify_and_update_data.py`

‚úÖ Tests automatizados pasados:
- `test_ohlc_validation.py` (11/11)
- `test_one_year_backtest.py` (5/5)

---

## Paso 1: Verificar Estado Actual de Datos

### Comando:
```bash
python verify_and_update_data.py --report-only
```

### Salida Esperada:
```
================================================================================
DATA FRESHNESS REPORT
================================================================================

‚úÖ BTC/USDT:USDT (moderate)
   Last update: 2025-10-07
   Status: Data is current

‚ö†Ô∏è BTC/USDT:USDT (aggressive)
   Last update: 2025-10-03
   Status: Data is 4 days old

...
================================================================================
Summary: X fresh, Y stale, Z with errors
================================================================================
```

### Verificar:
- [ ] ¬øCu√°ntos archivos est√°n frescos (‚úÖ)?
- [ ] ¬øCu√°ntos est√°n obsoletos (‚ö†Ô∏è)?
- [ ] ¬øHay errores registrados?

---

## Paso 2: Actualizar Datos Obsoletos

### Comando:
```bash
python verify_and_update_data.py
```

### Proceso Esperado:
```
2025-10-07 XX:XX:XX - INFO - Updating BTC/USDT:USDT aggressive...
2025-10-07 XX:XX:XX - INFO - üìä Effective config for BTC/USDT:USDT aggressive: {...}
2025-10-07 XX:XX:XX - INFO - ‚úÖ Backtest completed successfully
2025-10-07 XX:XX:XX - INFO - ‚úÖ OK: Saved 156 total trades to ...
```

### Observar:
- [ ] ¬øSe completa sin errores?
- [ ] ¬øMuestra "Backtest completed successfully"?
- [ ] ¬øEl n√∫mero de trades es razonable (100-200+)?
- [ ] Si hay errores de red, ¬øse reintenta 3 veces?

### En caso de error de red:
```
2025-10-07 XX:XX:XX - WARNING - Attempt 1/4 failed: ... Retrying in 2.0s...
2025-10-07 XX:XX:XX - WARNING - Attempt 2/4 failed: ... Retrying in 4.0s...
2025-10-07 XX:XX:XX - INFO - ‚úÖ Backtest completed successfully
```

---

## Paso 3: Verificar Archivos Meta.json

### Archivo de Ejemplo:
```bash
cat data/trades_final_BTC_USDT_USDT_moderate_meta.json
```

### Campos a Verificar:

```json
{
  "last_backtest_until": "2025-10-07",        // ‚Üê Debe ser hoy o ayer
  "first_trade_date": "2024-10-07",           // ‚Üê Debe ser ~365 d√≠as atr√°s
  "actual_lookback_days": 365,                // ‚Üê Debe ser >= 365
  "configured_lookback_days": 365,            // ‚Üê Debe ser 365
  "total_trades": 142,                        // ‚Üê Debe ser 100-200+
  "rebuild_type": "complete",                 // ‚Üê "complete" en primera ejecuci√≥n
  "last_error": null                          // ‚Üê Debe ser null si fue exitoso
}
```

### Checklist:
- [ ] `last_backtest_until` >= hoy - 1 d√≠a
- [ ] `first_trade_date` ~ 365 d√≠as atr√°s
- [ ] `actual_lookback_days` >= 365
- [ ] `configured_lookback_days` = 365
- [ ] `total_trades` > 50 (m√≠nimo razonable para 1 a√±o)
- [ ] `last_error` = null (o con detalles si hubo error)

---

## Paso 4: Lanzar Aplicaci√≥n Web

### Comando:
```bash
python webapp/app.py
```

### Salida Esperada:
```
Dash is running on http://0.0.0.0:8050/

 * Serving Flask app 'One Trade'
 * Debug mode: on
```

### Abrir Navegador:
```
http://localhost:8050
```

---

## Paso 5: Verificar Hero Section

### Verificar visualizaci√≥n:
- [ ] **Precio en vivo**: Muestra precio actual (ej: $60,234.50)
- [ ] **Variaci√≥n**: Muestra cambio vs d√≠a anterior con color (verde/rojo)
- [ ] **Ventana de entrada**: Muestra horario (ej: 11:00 - 14:00)
- [ ] **Estado de sesi√≥n**: Muestra emoji (üü¢/üî¥/‚è∏Ô∏è)
- [ ] **Riesgo**: Muestra monto USDT
- [ ] **Estado trade**: "Trade Activo" o "Sin Trade"

---

## Paso 6: Verificar Tabla de Trades

### Acceder:
Navegar a la pesta√±a **"Trades"** en el dashboard

### Verificar:
1. **Primera operaci√≥n** (scroll hasta el final):
   - [ ] `entry_time` debe ser ~365 d√≠as atr√°s
   - Ejemplo: Si hoy es 2025-10-07, debe haber trades desde 2024-10-07

2. **√öltima operaci√≥n** (parte superior):
   - [ ] `entry_time` debe ser reciente (hoy o ayer)
   - [ ] Debe coincidir con `last_trade_date` del meta.json

3. **Total de operaciones**:
   - [ ] Contador muestra 100-200+ trades
   - [ ] Debe coincidir con `total_trades` del meta.json

4. **Filtrado y ordenamiento**:
   - [ ] Ordenar por fecha (ascendente) ‚Üí verifica que va de 2024 a 2025
   - [ ] Filtrar por "long" ‚Üí verifica que se pueden filtrar
   - [ ] Filtrar por "take_profit" ‚Üí verifica exit reasons

---

## Paso 7: Probar Modo Invertido

### Activar Inversi√≥n:
1. Activar switch "Invertir Estrategia" en navbar
2. Presionar bot√≥n "Refrescar"

### Verificar:
- [ ] Badge "INVERTIDA" aparece en hero section y panel de estrategia
- [ ] Tabla de trades muestra:
  - Sides invertidos (long ‚Üî short)
  - PnL invertidos (100 ‚Üí -100)
  - Exit reasons invertidos (take_profit ‚Üî stop_loss)
- [ ] **Cobertura se mantiene**: Primera operaci√≥n sigue siendo ~365 d√≠as atr√°s
- [ ] **Total trades igual**: Mismo n√∫mero de operaciones que en modo normal
- [ ] M√©tricas actualizadas con interpretaci√≥n est√°ndar

---

## Paso 8: Verificar Gr√°fico de Precios

### Navegar:
Pesta√±a "Price Chart"

### Verificar:
- [ ] Gr√°fico muestra historial de precios
- [ ] Marcadores de entrada (tri√°ngulos verdes/rojos)
- [ ] Marcadores de salida (X verdes/rojos)
- [ ] **L√≠neas horizontales** para recomendaci√≥n del d√≠a:
  - üîµ Entry (l√≠nea azul punteada)
  - üî¥ SL (l√≠nea roja punteada)
  - üü¢ TP (l√≠nea verde punteada)
- [ ] Anotaciones en margen derecho con precios

---

## Paso 9: Probar Diferentes S√≠mbolos y Modos

### Para cada combinaci√≥n:
| S√≠mbolo | Modo | Acci√≥n |
|---------|------|--------|
| BTC/USDT:USDT | Conservative | Verificar 365 d√≠as |
| BTC/USDT:USDT | Moderate | Verificar 365 d√≠as |
| BTC/USDT:USDT | Aggressive | Verificar 365 d√≠as |
| ETH/USDT:USDT | Moderate | Verificar 365 d√≠as |

### Para cada uno:
1. Seleccionar s√≠mbolo y modo
2. Presionar "Refrescar"
3. Verificar tabla de trades:
   - [ ] Primera operaci√≥n ~365 d√≠as atr√°s
   - [ ] Total trades > 50
4. Verificar meta.json:
   - [ ] `actual_lookback_days` >= 365
5. Alternar modo invertido:
   - [ ] Cobertura se mantiene en 365 d√≠as

---

## Paso 10: Simular Error de Red

### M√©todo 1: Deshabilitar Internet Temporalmente
1. Desconectar WiFi/Ethernet
2. En la app, presionar "Refrescar"
3. Observar en terminal:
   ```
   WARNING - Attempt 1/4 failed: ... Retrying in 2.0s...
   WARNING - Attempt 2/4 failed: ... Retrying in 4.0s...
   WARNING - Attempt 3/4 failed: ... Retrying in 8.0s...
   ERROR - All 4 attempts failed. Last error: ...
   ```
4. Verificar alerta en UI:
   - [ ] Alerta roja con mensaje "Problema de conexi√≥n"
   - [ ] Incluye instrucci√≥n "Verifica tu conexi√≥n y presiona 'Refrescar'"
5. Reconectar internet y presionar "Refrescar"
6. Verificar:
   - [ ] Actualizaci√≥n exitosa despu√©s de reconectar
   - [ ] Alerta verde "Actualizado correctamente"

### M√©todo 2: Reconectar Durante Retry
1. Desconectar internet
2. Presionar "Refrescar"
3. Reconectar internet DURANTE los retries
4. Observar:
   - [ ] Retry 1 o 2 falla
   - [ ] Retry 3 o 4 **√©xito**
   - [ ] Meta.json se actualiza con `last_error = null`

---

## Paso 11: Verificar Rebuild por Historial Insuficiente

### Setup:
1. Editar manualmente un `_meta.json` para simular historial insuficiente:
   ```json
   {
     "first_trade_date": "2025-09-01",  // Solo 1 mes atr√°s
     "actual_lookback_days": 36
   }
   ```
2. Guardar archivo

### Verificar:
1. Lanzar app: `python webapp/app.py`
2. Seleccionar el s√≠mbolo/modo modificado
3. Presionar "Refrescar"
4. Observar en logs:
   ```
   WARNING - Insufficient history: only 36 days, need 365+ for valid backtest
   INFO - üîÑ Insufficient history detected: forcing full rebuild with 1-year data
   INFO - üìÖ Rebuilding from: 2024-10-07 (365+ days)
   ```
5. Verificar en tabla de trades:
   - [ ] Primera operaci√≥n ahora es ~365 d√≠as atr√°s (no solo 36)
   - [ ] Total trades aument√≥ significativamente
6. Verificar meta.json actualizado:
   - [ ] `actual_lookback_days` >= 365
   - [ ] `rebuild_type` = "complete"

---

## Paso 12: Verificar Coherencia de M√©tricas

### Para cada s√≠mbolo/modo:
1. Anotar m√©tricas en modo normal:
   - Win rate: _____%
   - Total PnL: _____
   - Max DD: _____
   - Total trades: _____

2. Activar modo invertido

3. Anotar m√©tricas en modo invertido:
   - Win rate: _____ (deber√≠a ser 100 - win_rate_normal)
   - Total PnL: _____ (deber√≠a ser -total_pnl_normal)
   - Max DD: _____ (deber√≠a ser negativo, no positivo)
   - Total trades: _____ (deber√≠a ser igual)

4. Verificar:
   - [ ] Total trades es exactamente igual en ambos modos
   - [ ] Win rate invertido = 100 - win rate normal (¬± 0.1%)
   - [ ] Total PnL invertido = - total PnL normal
   - [ ] Max DD siempre negativo en ambos modos

---

## Checklist Final

### Configuraci√≥n:
- [ ] `BASE_CONFIG.lookback_days` = 365
- [ ] `get_effective_config()` enforce >= 365
- [ ] `refresh_trades()` detecta historial insuficiente

### Validaci√≥n OHLC:
- [ ] `standardize_ohlc_columns()` normaliza nombres
- [ ] `validate_data_integrity()` verifica datos
- [ ] Errores lanzados son claros y accionables

### Metadata:
- [ ] `first_trade_date` presente en todos los meta.json
- [ ] `actual_lookback_days` >= 365
- [ ] `configured_lookback_days` = 365
- [ ] `total_trades` > 50
- [ ] `rebuild_type` correcto

### UI:
- [ ] Hero section funcional
- [ ] L√≠neas horizontales en gr√°fico de precios
- [ ] Tabla muestra 365 d√≠as de trades
- [ ] Modo invertido mantiene 365 d√≠as
- [ ] Alertas muestran colores y mensajes correctos

### Robustez:
- [ ] Retry funciona en errores de red
- [ ] Rebuild autom√°tico con historial insuficiente
- [ ] Meta.json se actualiza incluso en errores
- [ ] Logs informativos en todos los flujos

---

## Criterios de √âxito

### M√≠nimo Aceptable:
‚úÖ Todos los s√≠mbolos/modos tienen >= 365 d√≠as de cobertura
‚úÖ Meta.json actualizado con campos completos
‚úÖ No hay errores en validaci√≥n OHLC
‚úÖ Modo invertido funciona correctamente

### √ìptimo:
‚úÖ Actualizaci√≥n incremental funciona (no rebuilds innecesarios)
‚úÖ Retry recupera de errores transitorios de red
‚úÖ Alerts muestran mensajes espec√≠ficos y accionables
‚úÖ Performance aceptable (< 5 min primera carga, < 30s incrementales)

---

## Problemas Comunes y Soluciones

### Problema: "Insufficient data: X candles (minimum 24 required)"
**Causa**: Exchange no devolvi√≥ suficientes datos  
**Soluci√≥n**:
1. Verificar que el s√≠mbolo tiene historial >= 1 a√±o en el exchange
2. Revisar conectividad con `verify_and_update_data.py --force`
3. Probar con timeframe diferente si persiste

### Problema: "Missing required OHLC columns: ['close']"
**Causa**: Respuesta de CCXT con formato inesperado  
**Soluci√≥n**:
1. Revisar logs para ver columnas recibidas: `Available columns: [...]`
2. A√±adir variaci√≥n a `column_mappings` en `standardize_ohlc_columns()`
3. Reportar issue si es un formato nuevo de CCXT

### Problema: Tabla muestra solo 30 d√≠as de trades
**Causa**: Configuraci√≥n antigua no se reconstruy√≥  
**Soluci√≥n**:
1. Eliminar archivo CSV y meta.json manualmente
2. Presionar "Refrescar" en la app
3. Verificar logs muestran "forcing complete rebuild"
4. Confirmar nueva cobertura de 365 d√≠as

### Problema: Meta.json tiene `last_error: {type: "network", ...}`
**Causa**: √öltima actualizaci√≥n fall√≥ por red  
**Soluci√≥n**:
1. Verificar conexi√≥n a internet
2. Revisar si Binance est√° operativo (https://www.binance.com/en/support/announcement)
3. Ejecutar `python verify_and_update_data.py --symbol "BTC/USDT:USDT" --mode moderate`
4. Si persiste, esperar y reintentar m√°s tarde

---

## Reporte de Verificaci√≥n (Template)

```
VERIFICACI√ìN MANUAL - BACKTESTS DE 365 D√çAS
Fecha: _________________
Verificador: _________________

PASO 1: Estado Actual
  ‚úÖ/‚ùå Archivos frescos: ___/___
  ‚úÖ/‚ùå Archivos obsoletos: ___/___
  ‚úÖ/‚ùå Archivos con errores: ___/___

PASO 2: Actualizaci√≥n
  ‚úÖ/‚ùå Actualizaci√≥n completada sin errores
  ‚úÖ/‚ùå Reintentos funcionaron en errores de red
  ‚úÖ/‚ùå Todos los archivos actualizados exitosamente

PASO 3: Metadata
  ‚úÖ/‚ùå first_trade_date ~365 d√≠as atr√°s
  ‚úÖ/‚ùå actual_lookback_days >= 365
  ‚úÖ/‚ùå total_trades > 50
  ‚úÖ/‚ùå last_error = null

PASO 4: Aplicaci√≥n Web
  ‚úÖ/‚ùå App inicia sin errores
  ‚úÖ/‚ùå Hero section funcional
  ‚úÖ/‚ùå Tabla muestra 365 d√≠as de trades
  ‚úÖ/‚ùå Gr√°fico con l√≠neas horizontales
  ‚úÖ/‚ùå Modo invertido mantiene 365 d√≠as

PASO 5: Robustez
  ‚úÖ/‚ùå Retry funciona
  ‚úÖ/‚ùå Rebuild autom√°tico funciona
  ‚úÖ/‚ùå Alertas muestran mensajes claros

RESULTADO GLOBAL: ‚úÖ PASS / ‚ùå FAIL

NOTAS:
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________
```

---

## Siguiente Revisi√≥n

**Frecuencia recomendada**: Semanal

**Comandos r√°pidos**:
```bash
# Verificaci√≥n r√°pida
python verify_and_update_data.py --report-only

# Ver metadata de un archivo espec√≠fico
cat data/trades_final_BTC_USDT_USDT_moderate_meta.json | grep -E "(first_trade_date|actual_lookback_days|total_trades)"
```

**Alertas cr√≠ticas**:
- üî¥ `actual_lookback_days` < 365
- üî¥ `last_error` != null por m√°s de 3 d√≠as
- üü° Alg√∫n archivo con `last_backtest_until` < hoy - 1

---

## Conclusi√≥n

Esta gu√≠a asegura que el sistema mantiene **backtests de 365 d√≠as m√≠nimo**, garantizando:
- M√©tricas estad√≠sticamente significativas
- Validaci√≥n robusta de estrategias
- Comparaci√≥n justa entre modo normal e invertido
- Detecci√≥n temprana de problemas de datos

**Tiempo estimado de verificaci√≥n completa**: 15-20 minutos  
**Frecuencia recomendada**: Semanal o despu√©s de cada deploy

